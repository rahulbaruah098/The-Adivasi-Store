{% extends "base.html" %}
{% block content %}
<main>
  <section class="admin-wrap">
    <style>
      /* ==============================
         Admin Dashboard ‚Äî Classic Pro
         + Products (NEW)
         Scoped to this template only
         ============================== */


         .img2-grid{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap:14px;
          }

          .img2{
            border:1px solid rgba(0,0,0,0.10);
            border-radius:14px;
            padding:12px;
            background: rgba(255,255,255,0.35);
          }

          .img2-label{
            font-size:11px;
            letter-spacing:.18em;
            text-transform:uppercase;
            color:#4b4741;
            margin-bottom:8px;
            font-family:"Fjalla One",sans-serif;
          }

          .hint.mini{
            font-size:12px;
            opacity:.75;
            margin-top:6px;
          }

          /* Reuse your preview styles, just ensure image fits nicely */
          .preview .ph{
            width:100%;
            aspect-ratio: 3/4;
            border-radius:12px;
            overflow:hidden;
            background:#e9e3da;
            border:1px solid rgba(0,0,0,0.08);
          }

          .preview .ph img{
            width:100%;
            height:100%;
            object-fit:cover;
            display:block;
          }

          /* Mobile */
          @media (max-width:720px){
            .img2-grid{ grid-template-columns: 1fr; }
          }
      :root{
        --bg: #f6efe5;
        --paper: #fffaf2;
        --card: #fbf5ea;
        --ink: #22150e;
        --muted: rgba(34,21,14,0.62);
        --line: rgba(0,0,0,0.08);
        --line2: rgba(0,0,0,0.12);
        --shadow: 0 12px 26px rgba(0,0,0,0.12);
        --shadow2: 0 10px 22px rgba(0,0,0,0.10);
        --radius: 16px;
        --radius2: 14px;
        --pill: 999px;
        --accent: #2b6cb0; /* subtle classic blue */
        --good: #2f855a;
        --warn: #b7791f;
        --bad: #c53030;
        --focus: 0 0 0 4px rgba(43,108,176,0.18);
      }

      .admin-wrap{
        min-height: 100vh;
        padding: 130px 20px 80px;
        background:
          radial-gradient(circle at 12% 0%, #fff6ea 0, #f3e4d2 32%, #ead9c6 64%, #e1cfbc 100%);
        color: var(--ink);
        position: relative;
        overflow: hidden;
      }

      .admin-container{
        max-width: 1120px;
        margin: 0 auto;
      }

      /* Header */
      .admin-header{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap: 14px;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }

      .admin-title{
        margin:0;
        font-size: 22px;
        text-transform: uppercase;
        letter-spacing: .18em;
        line-height: 1.2;
      }

      .admin-sub{
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: .06em;
      }

      .admin-actions{
        display:flex;
        gap:10px;
        flex-wrap: wrap;
        align-items:center;
      }

      .pill-link, .pill-btn{
        display:inline-flex;
        align-items:center;
        gap:10px;
        padding: 9px 14px;
        border-radius: var(--pill);
        border: 1px solid rgba(0,0,0,0.22);
        background: rgba(255,250,242,0.65);
        box-shadow: 0 8px 18px rgba(0,0,0,0.08);
        color: var(--ink);
        text-decoration:none;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: .16em;
        cursor:pointer;
        transition: transform .15s ease, background .15s ease, border-color .15s ease;
      }
      .pill-link:hover, .pill-btn:hover{
        transform: translateY(-1px);
        background: rgba(255,250,242,0.95);
        border-color: rgba(0,0,0,0.28);
      }
      .pill-link:focus, .pill-btn:focus{
        outline:none;
        box-shadow: var(--focus), 0 8px 18px rgba(0,0,0,0.08);
      }

      /* KPI row */
      .kpi-row{
        display:grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 14px;
        margin: 18px 0 18px;
      }

      .kpi{
        grid-column: span 4;
        padding: 16px 16px;
        border-radius: var(--radius2);
        border: 1px solid var(--line);
        background: var(--card);
        box-shadow: var(--shadow2);
        position: relative;
        overflow: hidden;
      }

      .kpi::after{
        content:"";
        position:absolute;
        inset:-60px -120px auto auto;
        width:200px;height:200px;
        border-radius:999px;
        background: radial-gradient(circle at 30% 30%, rgba(43,108,176,0.18), rgba(43,108,176,0.02) 60%, transparent 70%);
        transform: rotate(12deg);
      }

      .kpi h3{
        margin:0 0 6px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: .16em;
      }

      .kpi .kpi-value{
        font-size: 18px;
        font-weight: 800;
        margin: 0;
        position: relative;
        z-index: 1;
      }

      .kpi .kpi-meta{
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        position: relative;
        z-index: 1;
      }

      .badge{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: .14em;
        border: 1px solid rgba(0,0,0,0.22);
        background: rgba(255,250,242,0.85);
        margin-left: 10px;
      }

      /* Tabs */
      .tabs{
        margin-top: 10px;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: rgba(255,250,242,0.55);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .tabbar{
        display:flex;
        gap: 6px;
        padding: 10px;
        border-bottom: 1px solid var(--line);
        background: rgba(255,250,242,0.8);
        flex-wrap: wrap;
      }

      .tab-btn{
        appearance:none;
        border: 1px solid rgba(0,0,0,0.18);
        background: rgba(255,255,255,0.55);
        padding: 10px 12px;
        border-radius: 999px;
        cursor:pointer;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: .16em;
        color: var(--ink);
        display:inline-flex;
        align-items:center;
        gap: 10px;
        transition: transform .15s ease, background .15s ease, border-color .15s ease;
      }
      .tab-btn:hover{
        transform: translateY(-1px);
        border-color: rgba(0,0,0,0.28);
        background: rgba(255,255,255,0.88);
      }
      .tab-btn[aria-selected="true"]{
        background: rgba(43,108,176,0.10);
        border-color: rgba(43,108,176,0.30);
      }
      .tab-btn:focus{
        outline:none;
        box-shadow: var(--focus);
      }

      .tabcount{
        font-size: 11px;
        letter-spacing: .08em;
        color: rgba(34,21,14,0.72);
        background: rgba(0,0,0,0.06);
        border: 1px solid rgba(0,0,0,0.10);
        padding: 3px 10px;
        border-radius: 999px;
      }

      .tab-panels{
        padding: 14px;
      }

      .panel{ display:none; }
      .panel.active{ display:block; }

      /* Toolbar */
      .toolbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .toolbar .left,
      .toolbar .right{
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items:center;
      }

      .field{
        display:flex;
        align-items:center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,0.16);
        background: rgba(255,255,255,0.55);
        box-shadow: 0 8px 18px rgba(0,0,0,0.06);
      }

      .field input{
        border:none;
        outline:none;
        background: transparent;
        font-size: 13px;
        min-width: 240px;
        color: var(--ink);
      }

      .field select{
        border:none;
        outline:none;
        background: transparent;
        font-size: 12px;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: rgba(34,21,14,0.85);
        cursor:pointer;
      }

      /* Cards */
      .card{
        padding: 16px 18px;
        border-radius: var(--radius2);
        border: 1px solid var(--line);
        background: var(--card);
        box-shadow: var(--shadow2);
        margin-bottom: 14px;
      }

      .cardhead{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap: 12px;
        flex-wrap: wrap;
      }

      .titleline{
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: .14em;
      }

      .subline{
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }

      .rightmeta{
        text-align:right;
        font-size: 12px;
      }

      .status{
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: .12em;
        font-size: 11px;
        display:inline-flex;
        align-items:center;
        gap: 8px;
        justify-content:flex-end;
      }

      .dot{
        width: 9px;
        height: 9px;
        border-radius: 999px;
        display:inline-block;
        background: rgba(0,0,0,0.25);
        box-shadow: 0 0 0 4px rgba(0,0,0,0.05);
      }
      .dot.good{ background: var(--good); box-shadow: 0 0 0 4px rgba(47,133,90,0.12); }
      .dot.warn{ background: var(--warn); box-shadow: 0 0 0 4px rgba(183,121,31,0.14); }
      .dot.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(197,48,48,0.12); }

      .divider{
        margin-top: 12px;
        border-top: 1px dashed rgba(0,0,0,0.12);
        padding-top: 12px;
      }

      /* Order item rows */
      .item{
        display:flex;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        align-items:flex-start;
      }

      .thumb{
        width: 64px;
        height: 74px;
        border-radius: 12px;
        overflow:hidden;
        box-shadow: 0 10px 18px rgba(0,0,0,0.16);
        flex-shrink: 0;
        border: 1px solid rgba(0,0,0,0.08);
        background: rgba(255,255,255,0.6);
      }
      .thumb img{
        width:100%;
        height:100%;
        object-fit: cover;
        display:block;
      }

      .item .name{
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: .12em;
      }
      .item .meta{
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .item .row{
        margin-top: 6px;
        font-size: 12px;
        display:flex;
        justify-content:space-between;
        gap: 10px;
        color: rgba(34,21,14,0.9);
      }

      .footrow{
        margin-top: 12px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 11px;
        color: var(--muted);
      }

      .cta{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,0.30);
        text-decoration:none;
        text-transform: uppercase;
        letter-spacing: .16em;
        font-size: 11px;
        color: var(--ink);
        background: rgba(255,250,242,0.75);
        transition: transform .15s ease, background .15s ease;
        cursor:pointer;
      }
      .cta:hover{
        transform: translateY(-1px);
        background: rgba(255,250,242,0.95);
      }

      .cta.primary{
        border-color: rgba(43,108,176,0.38);
        background: rgba(43,108,176,0.10);
      }
      .cta.danger{
        border-color: rgba(197,48,48,0.35);
        background: rgba(197,48,48,0.08);
      }

      .empty{
        padding: 18px;
        border-radius: var(--radius2);
        border: 1px dashed rgba(0,0,0,0.18);
        color: var(--muted);
        background: rgba(255,255,255,0.35);
      }

      /* ------------------------------
         PRODUCTS (NEW)
      ------------------------------ */
      .grid2{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      .form-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }
      .fg{
        display:flex;
        flex-direction:column;
        gap: 7px;
      }
      .fg label{
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: .14em;
        color: rgba(34,21,14,0.78);
      }
      .fg input, .fg textarea, .fg select{
        width:100%;
        border: 1px solid rgba(0,0,0,0.18);
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(255,255,255,0.65);
        color: var(--ink);
        outline:none;
        font-size: 13px;
      }
      .fg textarea{
        min-height: 110px;
        resize: vertical;
        line-height: 1.6;
      }
      .fg input:focus, .fg textarea:focus, .fg select:focus{
        box-shadow: var(--focus);
        border-color: rgba(43,108,176,0.35);
      }
      .full{ grid-column: 1 / -1; }

      .preview{
        display:flex;
        gap:12px;
        align-items:flex-start;
        padding: 12px;
        border-radius: 14px;
        border: 1px dashed rgba(0,0,0,0.18);
        background: rgba(255,255,255,0.35);
        margin-top: 12px;
      }
      .preview .ph{
        width: 84px;
        height: 96px;
        border-radius: 14px;
        overflow:hidden;
        border: 1px solid rgba(0,0,0,0.10);
        background: rgba(255,255,255,0.55);
        box-shadow: 0 10px 18px rgba(0,0,0,0.12);
        flex-shrink: 0;
      }
      .preview .ph img{
        width:100%;
        height:100%;
        object-fit: cover;
        display:block;
      }
      .preview .meta{
        flex:1;
        font-size: 12px;
        color: rgba(34,21,14,0.88);
        line-height: 1.7;
      }
      .hint{
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
        line-height: 1.65;
      }

      /* Responsive */
      @media (max-width: 980px){
        .kpi{ grid-column: span 6; }
        .field input{ min-width: 180px; }
        .grid2{ grid-template-columns: 1fr; }
      }
      @media (max-width: 640px){
        .kpi{ grid-column: span 12; }
        .field{ width: 100%; }
        .field input{ width: 100%; min-width: 0; }
        .form-grid{ grid-template-columns: 1fr; }
      }


      /* ------------------------------
   ADD STOCK (NEW TAB)
   - table-like grid
   - same theme tokens & shadows
------------------------------ */

.stock-table{
  width:100%;
  border-radius: var(--radius2);
  border: 1px solid var(--line);
  background: rgba(255,255,255,0.35);
  overflow:hidden;
  box-shadow: 0 10px 22px rgba(0,0,0,0.08);
}

.stock-head{
  display:grid;
  grid-template-columns: 64px 1.4fr 140px 160px 160px;
  gap: 0;
  padding: 12px 12px;
  background: rgba(255,250,242,0.85);
  border-bottom: 1px solid var(--line);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .16em;
  color: rgba(34,21,14,0.78);
  font-family: "Fjalla One", sans-serif;
}

.stock-row{
  display:grid;
  grid-template-columns: 64px 1.4fr 140px 160px 160px;
  gap: 0;
  padding: 12px 12px;
  align-items:center;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  background: rgba(255,255,255,0.22);
}

.stock-row:nth-child(even){
  background: rgba(255,255,255,0.30);
}

.stock-row:last-child{
  border-bottom: none;
}

.stock-name{
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: rgba(34,21,14,0.95);
}

.stock-left{
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .08em;
  color: rgba(34,21,14,0.92);
}

.stock-input{
  width: 100%;
  border: 1px solid rgba(0,0,0,0.18);
  border-radius: 999px;
  padding: 10px 12px;
  background: rgba(255,255,255,0.65);
  color: var(--ink);
  outline:none;
  font-size: 13px;
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  box-shadow: 0 8px 18px rgba(0,0,0,0.06);
}

.stock-input:focus{
  box-shadow: var(--focus), 0 8px 18px rgba(0,0,0,0.06);
  border-color: rgba(43,108,176,0.35);
  background: rgba(255,255,255,0.88);
}

.stock-btn{
  width: 100%;
  appearance:none;
  border: 1px solid rgba(0,0,0,0.30);
  border-radius: 999px;
  padding: 10px 12px;
  background: rgba(43,108,176,0.10);
  color: var(--ink);
  cursor:pointer;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .16em;
  font-family: "Fjalla One", sans-serif;
  transition: transform .15s ease, background .15s ease, border-color .15s ease;
  box-shadow: 0 8px 18px rgba(0,0,0,0.08);
}

.stock-btn:hover{
  transform: translateY(-1px);
  background: rgba(43,108,176,0.16);
  border-color: rgba(43,108,176,0.38);
}

.stock-btn:active{
  transform: translateY(1px);
}

@media (max-width: 980px){
  .stock-head,
  .stock-row{
    grid-template-columns: 54px 1.2fr 120px 140px 140px;
  }
}

@media (max-width: 760px){
  /* Stack into neat blocks on mobile */
  .stock-head{ display:none; }

  .stock-row{
    grid-template-columns: 1fr;
    gap: 10px;
    padding: 14px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }

  .stock-row > div{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }

  .stock-row > div:nth-child(1)::before{ content:"SL"; font-size:11px; letter-spacing:.16em; text-transform:uppercase; color: var(--muted); font-family:"Fjalla One",sans-serif; }
  .stock-row > div:nth-child(2)::before{ content:"Product"; font-size:11px; letter-spacing:.16em; text-transform:uppercase; color: var(--muted); font-family:"Fjalla One",sans-serif; }
  .stock-row > div:nth-child(3)::before{ content:"Stocks left"; font-size:11px; letter-spacing:.16em; text-transform:uppercase; color: var(--muted); font-family:"Fjalla One",sans-serif; }
  .stock-row > div:nth-child(4)::before{ content:"Add stock"; font-size:11px; letter-spacing:.16em; text-transform:uppercase; color: var(--muted); font-family:"Fjalla One",sans-serif; }
  .stock-row > div:nth-child(5)::before{ content:"Action"; font-size:11px; letter-spacing:.16em; text-transform:uppercase; color: var(--muted); font-family:"Fjalla One",sans-serif; }

  .stock-name{
    text-align:right;
    max-width: 70%;
  }
  .stock-left{
    text-align:right;
  }
  .stock-input{ max-width: 180px; }
  .stock-btn{ max-width: 220px; }
}
    </style>

    <div class="admin-container">
      <div class="admin-header">
        <div>
          <h1 class="admin-title">Store Admin Panel</h1>
          <div class="admin-sub">
            Manage orders, products, customer messages, and quick actions ‚Äî all in one place.
          </div>
        </div>

        <div class="admin-actions">
          <a class="pill-link" href="{{ url_for('admin_profile') }}">Admin Profile</a>
          <!-- NEW: quick jump to Products tab -->
          <button class="pill-btn" type="button" id="jumpProducts">Products</button>
        </div>
      </div>

      <!-- KPI Row -->
      <div class="kpi-row">
        <div class="kpi">
          <h3>Total revenue</h3>
          <p class="kpi-value">Rs. {{ "%.0f"|format(total_revenue) }}</p>
          <div class="kpi-meta">Lifetime sales total</div>
        </div>

        <div class="kpi">
          <h3>Live orders</h3>
          <p class="kpi-value">{{ live_orders|length }} active</p>
          <div class="kpi-meta">Orders currently in progress</div>
        </div>

        <div class="kpi">
          <h3>Contact messages</h3>
          <p class="kpi-value">
            {{ contact_messages|length if contact_messages else 0 }} total
            {% if new_contact_count and new_contact_count > 0 %}
              <span class="badge">{{ new_contact_count }} New</span>
            {% endif %}
          </p>
          <div class="kpi-meta">Customer / visitor messages</div>
        </div>
      </div>

      <!-- Tabs (Sheets) -->
      <div class="tabs" id="adminTabs">
        <div class="tabbar" role="tablist" aria-label="Admin sheets">
          <button class="tab-btn" role="tab" aria-selected="true" data-tab="orders">
            Orders <span class="tabcount">{{ orders|length if orders else 0 }}</span>
          </button>

          <!-- NEW TAB -->
          <button class="tab-btn" role="tab" aria-selected="false" data-tab="products">
            Products <span class="tabcount">{{ products|length if products else 0 }}</span>
          </button>

          <button class="tab-btn" role="tab" aria-selected="false" data-tab="messages">
            Contact Messages <span class="tabcount">{{ contact_messages|length if contact_messages else 0 }}</span>
          </button>

          <button class="tab-btn" role="tab" aria-selected="false" data-tab="addstock">
            Add Stock <span class="tabcount">{{ products|length if products else 0 }}</span>
          </button>
        </div>

        <div class="tab-panels">
          <!-- ======================
               ORDERS PANEL
               ====================== -->
          <div class="panel active" id="panel-orders" role="tabpanel">
            <div class="toolbar">
              <div class="left">
                <div class="field">
                  <span style="font-size:12px;opacity:.7;">üîé</span>
                  <input id="orderSearch" type="text" placeholder="Search orders by name, email, pincode, or order id‚Ä¶">
                </div>

                <div class="field">
                  <span style="font-size:12px;opacity:.7;">Filter</span>
                  <select id="orderStatusFilter">
                    <option value="">All statuses</option>
                    <option value="Pending">Pending</option>
                    <option value="Processing">Processing</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                    <option value="Paid">Paid</option>
                  </select>
                </div>
              </div>

              <div class="right">
                <button class="pill-btn" type="button" id="collapseAllOrders">Collapse items</button>
                <button class="pill-btn" type="button" id="expandAllOrders">Expand items</button>
              </div>
            </div>

            {% if orders %}
              <div id="ordersList">
                {% for o in orders %}
                  {% set o_search = (
                    (o.id|string) ~ " " ~
                    (o.shipping_name or "") ~ " " ~
                    (o.shipping_email or "") ~ " " ~
                    (o.shipping_pincode or "") ~ " " ~
                    (o.status or "") ~ " " ~
                    (o.tracking_message or "")
                  ) %}

                  <div class="card order-card"
                       data-status="{{ o.status }}"
                       data-search="{{ o_search|lower }}">
                    <div class="cardhead">
                      <div>
                        <div class="titleline">
                          Order #{{ o.id }} ¬∑ {{ o.created_at.strftime("%d %b %Y") }}
                        </div>
                        <div class="subline">
                          {{ o.shipping_name or 'No name' }} ¬∑ Rs. {{ "%.0f"|format(o.total_amount) }}
                        </div>
                      </div>

                      <div class="rightmeta">
                        <div class="status">
                          {% set s = (o.status or "")|lower %}
                          {% if "deliver" in s %}
                            <span class="dot good"></span>
                          {% elif "cancel" in s %}
                            <span class="dot bad"></span>
                          {% elif "ship" in s %}
                            <span class="dot warn"></span>
                          {% else %}
                            <span class="dot"></span>
                          {% endif %}
                          {{ o.status }}
                        </div>
                        <div class="subline" style="max-width:320px;">
                          {{ o.tracking_message }}
                        </div>
                      </div>
                    </div>

                    <div class="divider">
                      <details class="order-items" open>
                        <summary style="cursor:pointer;user-select:none;list-style:none;">
                          <span style="text-transform:uppercase;letter-spacing:.14em;font-size:11px;">
                            Items ({{ o.items|length }}) ‚Äî click to toggle
                          </span>
                        </summary>

                        <div style="margin-top:10px;">
                          {% for item in o.items %}
                            <div class="item">
                              {% if item.product_image %}
                                <div class="thumb">
                                  <img src="{{ item.product_image }}" alt="{{ item.product_name }}">
                                </div>
                              {% endif %}

                              <div style="flex:1;">
                                <div class="name">{{ item.product_name }}</div>
                                <div class="meta">
                                  {% if item.product_size %}<span>Size: {{ item.product_size }}</span>{% endif %}
                                  {% if item.product_color %}<span>Colour: {{ item.product_color }}</span>{% endif %}
                                </div>
                                <div class="row">
                                  <span>Qty: {{ item.quantity }}</span>
                                  <span>Rs. {{ "%.0f"|format(item.product_price * item.quantity) }}</span>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </details>

                      <div class="footrow">
                        <div>
                          Deliver to:
                          {{ o.shipping_name or o.shipping_email }},
                          {{ o.shipping_address }},
                          {{ o.shipping_post_office }} ‚Äì {{ o.shipping_pincode }}
                        </div>

                        <a class="cta" href="{{ url_for('admin_order_detail', order_id=o.id) }}">
                          View / Update
                        </a>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty">No orders yet.</div>
            {% endif %}
          </div>

          <!-- ======================
               PRODUCTS PANEL (NEW)
               ====================== -->
          <div class="panel" id="panel-products" role="tabpanel">
            <div class="toolbar">
              <div class="left">
                <div class="field">
                  <span style="font-size:12px;opacity:.7;">üîé</span>
                  <input id="prodSearch" type="text" placeholder="Search products by name, category, price‚Ä¶">
                </div>

                <div class="field">
                  <span style="font-size:12px;opacity:.7;">Category</span>
                  <select id="prodCategoryFilter">
                    <option value="">All</option>
                    {% for c in categories or [] %}
                      <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="field">
                  <span style="font-size:12px;opacity:.7;">Status</span>
                  <select id="prodStatusFilter">
                    <option value="">All</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Out">Out of stock</option>
                  </select>
                </div>
              </div>

              <div class="right">
                <button class="pill-btn" type="button" id="toggleAddProduct">Add product</button>
              </div>
            </div>

            <div class="grid2">
              <!-- Add Product -->
              <div class="card" id="addProductCard" style="display:none;">
                <div class="cardhead">
                  <div>
                    <div class="titleline">Add new product</div>
                    <div class="subline">Upload image + set category, stock, price & details.</div>
                  </div>
                  <div class="rightmeta">
                    <button class="cta" type="button" id="closeAddProduct">Close</button>
                  </div>
                </div>

                <div class="divider">
                  <!-- IMPORTANT: needs an /admin/products/create route in app.py -->
                  <form method="POST" action="{{ url_for('admin_create_product') }}" enctype="multipart/form-data" id="productForm">
                    <div class="form-grid">
                      <div class="fg">
                        <label>Product name</label>
                        <input name="name" required placeholder="Eg. Gamusa Saree (Red Border)">
                      </div>

                      <div class="fg">
                        <label>Category</label>
                        <select name="category" required>
                          <option value="" disabled selected>Select category</option>
                          {% for c in categories or [] %}
                            <option value="{{ c }}">{{ c }}</option>
                          {% endfor %}
                        </select>
                      </div>

                      <div class="fg">
                        <label>Price (Rs.)</label>
                        <input name="price" type="number" min="0" step="1" required placeholder="Eg. 2490">
                      </div>

                      <div class="fg">
                        <label>Stock</label>
                        <input name="stock" type="number" min="0" step="1" required placeholder="Eg. 20">
                      </div>

                      <div class="fg">
                        <label>Sizes (comma separated)</label>
                        <input name="sizes" placeholder="Eg. S,M,L,XL (or Free Size)">
                      </div>

                      <div class="fg">
                        <label>Colours (comma separated)</label>
                        <input name="colors" placeholder="Eg. Red,Black">
                      </div>

                      <div class="fg full">
                        <label>Description</label>
                        <textarea name="description" placeholder="Write product details (material, care, notes)‚Ä¶"></textarea>
                      </div>

                        <div class="fg full">
                          <label>Images (Front + Back)</label>

                          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <div>
                              <div style="font-size:12px; letter-spacing:.14em; text-transform:uppercase; opacity:.7; margin-bottom:6px;">
                                Front image
                              </div>
                              <input name="images" type="file" accept="image/*" required id="prodImageFront">
                            </div>

                            <div>
                              <div style="font-size:12px; letter-spacing:.14em; text-transform:uppercase; opacity:.7; margin-bottom:6px;">
                                Back / Hover image
                              </div>
                              <input name="images" type="file" accept="image/*" required id="prodImageBack">
                            </div>
                          </div>

                          <div class="hint">
                            Tip: upload 2 images. They will be saved in <b>static/images/adivasi/</b>.
                          </div>

                          <!-- Optional previews -->
                          <div class="preview" id="prodPreview" style="display:none;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                              <div class="ph"><img id="prodPreviewImgFront" alt="Front Preview"></div>
                              <div class="ph"><img id="prodPreviewImgBack" alt="Back Preview"></div>
                            </div>
                            <div class="meta" id="prodPreviewMeta"></div>
                          </div>
                        </div>
                    </div>

                    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
                      <button class="cta primary" type="submit">Save product</button>
                      <button class="cta" type="reset" id="resetProdForm">Reset</button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Products list -->
              <div class="card">
                <div class="cardhead">
                  <div>
                    <div class="titleline">Products</div>
                    <div class="subline">All admin-added products (DB). These will be used across your category pages.</div>
                  </div>
                  <div class="rightmeta">
                    <div class="subline">Total: {{ products|length if products else 0 }}</div>
                  </div>
                </div>

                <div class="divider">
                  {% if products %}
                    <div id="prodList">
                      {% for p in products %}
                        {% set p_status = "Active" if p.is_active else "Inactive" %}
                        {% set stock_state = "Out" if (p.stock or 0) <= 0 else "In" %}
                        {% set p_search = (
                          (p.name or "") ~ " " ~
                          (p.category or "") ~ " " ~
                          (p.price|string) ~ " " ~
                          (p.stock|string) ~ " " ~
                          (p_status) ~ " " ~
                          (stock_state)
                        ) %}

                        <div class="card prod-card"
                             style="margin-bottom:12px;"
                             data-search="{{ p_search|lower }}"
                             data-category="{{ p.category }}"
                             data-status="{{ p_status }}"
                             data-stock="{{ stock_state }}">
                          <div class="cardhead">
                            <div style="display:flex;gap:12px;align-items:flex-start;">
                              <div class="thumb" style="width:72px;height:82px;">
                                {% if p.image_url %}
                                  <img src="{{ p.image_url }}" alt="{{ p.name }}">
                                {% else %}
                                  <img src="https://via.placeholder.com/300x400?text=No+Image" alt="No image">
                                {% endif %}
                              </div>

                              <div>
                                <div class="titleline">{{ p.name }}</div>
                                <div class="subline">
                                  {{ p.category }} ¬∑ Rs. {{ "%.0f"|format(p.price or 0) }} ¬∑ Stock: {{ p.stock or 0 }}
                                  {% if not p.is_active %}
                                    <span class="badge">Inactive</span>
                                  {% elif (p.stock or 0) <= 0 %}
                                    <span class="badge">Out of stock</span>
                                  {% endif %}
                                </div>
                              </div>
                            </div>

                            <div class="rightmeta">
                              <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;">
                                <!-- Needs route in app.py -->
                                <a class="cta" href="{{ url_for('admin_edit_product', product_id=p.id) }}">Edit</a>

                                <!-- Toggle active -->
                                <form method="POST" action="{{ url_for('admin_toggle_product', product_id=p.id) }}" style="display:inline;">
                                  <button type="submit" class="cta">
                                    {% if p.is_active %}Deactivate{% else %}Activate{% endif %}
                                  </button>
                                </form>

                                <!-- Delete -->
                                <form method="POST" action="{{ url_for('admin_delete_product', product_id=p.id) }}"
                                      style="display:inline;"
                                      onsubmit="return confirm('Delete this product? This cannot be undone.');">
                                  <button type="submit" class="cta danger">Delete</button>
                                </form>
                              </div>
                            </div>
                          </div>

                          {% if p.description or p.sizes or p.colors %}
                            <div class="divider" style="margin-top:10px;">
                              <details open>
                                <summary style="cursor:pointer;user-select:none;list-style:none;">
                                  <span style="text-transform:uppercase;letter-spacing:.14em;font-size:11px;">
                                    Details ‚Äî click to toggle
                                  </span>
                                </summary>

                                <div style="margin-top:10px;font-size:12px;line-height:1.75;color:rgba(34,21,14,0.92);">
                                  {% if p.description %}<div><strong>Description:</strong> {{ p.description }}</div>{% endif %}
                                  {% if p.sizes %}<div style="margin-top:6px;"><strong>Sizes:</strong> {{ p.sizes }}</div>{% endif %}
                                  {% if p.colors %}<div style="margin-top:6px;"><strong>Colours:</strong> {{ p.colors }}</div>{% endif %}
                                </div>
                              </details>
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="empty">No products added yet. Click ‚ÄúAdd product‚Äù.</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="hint">
              Note: The menu links (Saree, Bandi, Bags, etc.) will work best when your Product categories use the exact same names.
            </div>
          </div>

          <!-- ======================
               MESSAGES PANEL
               ====================== -->
          <div class="panel" id="panel-messages" role="tabpanel">
            <div class="toolbar">
              <div class="left">
                <div class="field">
                  <span style="font-size:12px;opacity:.7;">üîé</span>
                  <input id="msgSearch" type="text" placeholder="Search messages by name, email, phone, subject‚Ä¶">
                </div>

                <div class="field">
                  <span style="font-size:12px;opacity:.7;">Filter</span>
                  <select id="msgStatusFilter">
                    <option value="">All</option>
                    <option value="New">New</option>
                    <option value="Read">Read</option>
                    <option value="Replied">Replied</option>
                    <option value="Closed">Closed</option>
                  </select>
                </div>
              </div>

              <div class="right">
                <button class="pill-btn" type="button" id="collapseAllMsgs">Collapse</button>
                <button class="pill-btn" type="button" id="expandAllMsgs">Expand</button>
              </div>
            </div>

            {% if contact_messages and contact_messages|length > 0 %}
              <div id="msgsList">
                {% for m in contact_messages %}
                  {% set m_search = (
                    (m.name or "") ~ " " ~
                    (m.email or "") ~ " " ~
                    (m.phone or "") ~ " " ~
                    (m.subject or "") ~ " " ~
                    (m.status or "") ~ " " ~
                    (m.message or "")
                  ) %}

                  <div class="card msg-card"
                       data-status="{{ m.status }}"
                       data-search="{{ m_search|lower }}">
                    <div class="cardhead">
                      <div>
                        <div class="titleline">
                          {{ m.name }} ¬∑ {{ m.created_at.strftime("%d %b %Y") }}
                        </div>
                        <div class="subline">
                          {{ m.email }}{% if m.phone %} ¬∑ {{ m.phone }}{% endif %}
                        </div>
                      </div>

                      <div class="rightmeta">
                        <div class="status">
                          {% set ms = (m.status or "")|lower %}
                          {% if "new" in ms %}
                            <span class="dot warn"></span>
                          {% elif "read" in ms or "replied" in ms %}
                            <span class="dot good"></span>
                          {% elif "closed" in ms %}
                            <span class="dot"></span>
                          {% else %}
                            <span class="dot"></span>
                          {% endif %}
                          {{ m.status }}
                        </div>
                        {% if m.subject %}
                          <div class="subline" style="max-width:340px;">
                            Subject: {{ m.subject }}
                          </div>
                        {% endif %}
                      </div>
                    </div>

                    <div class="divider">
                      <details class="msg-body" open>
                        <summary style="cursor:pointer;user-select:none;list-style:none;">
                          <span style="text-transform:uppercase;letter-spacing:.14em;font-size:11px;">
                            Message ‚Äî click to toggle
                          </span>
                        </summary>
                        <div style="margin-top:10px;font-size:12px;line-height:1.75;color:rgba(34,21,14,0.92);">
                          {{ m.message }}
                        </div>
                      </details>

                      <div class="footrow">
                        <div></div>
                        {% if m.status == "New" %}
                          <form method="POST" action="{{ url_for('admin_mark_contact_read', msg_id=m.id) }}">
                            <button type="submit" class="cta" style="cursor:pointer;background:rgba(255,250,242,0.85);">
                              Mark as read
                            </button>
                          </form>
                        {% else %}
                          <span style="font-size:11px;color:var(--muted);">‚Äî</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty">No contact messages yet.</div>
            {% endif %}
          </div>

             <!-- ======================
              ADD STOCK PANEL (NEW TAB)
              ====================== -->
          <div class="panel" id="panel-addstock" role="tabpanel">
            <div class="toolbar">
              <div class="left">
                <div class="field">
                  <span style="font-size:12px;opacity:.7;">üîé</span>
                  <input id="stockSearch" type="text" placeholder="Search product by name, category‚Ä¶">
                </div>
              </div>
              <div class="right">
                <button class="pill-btn" type="button" id="collapseStockHelp">Collapse</button>
                <button class="pill-btn" type="button" id="expandStockHelp">Expand</button>
              </div>
            </div>

            <div class="card">
              <div class="cardhead">
                <div>
                  <div class="titleline">Add stock</div>
                  <div class="subline">Increase stock for existing products (updates Product.stock in DB).</div>
                </div>
                <div class="rightmeta">
                  <div class="subline">Only positive numbers allowed</div>
                </div>
              </div>

              <div class="divider">
                {% if products %}
                  <div class="stock-table" id="stockList">
                    <div class="stock-head">
                      <div>SL</div>
                      <div>Product</div>
                      <div>Stocks left</div>
                      <div>Add stock</div>
                      <div>Action</div>
                    </div>

                    {% for p in products %}
                      {% set stock_search = ((p.name or "") ~ " " ~ (p.category or "")) %}
                      <form class="stock-row"
                            method="POST"
                            action="{{ url_for('admin_add_stock', product_id=p.id) }}"
                            data-search="{{ stock_search|lower }}">
                        <div><strong>{{ loop.index }}</strong></div>

                        <div class="stock-name">
                          {{ p.name }}
                          <div class="subline" style="margin-top:6px;">{{ p.category }}</div>
                        </div>

                        <div class="stock-left">{{ p.stock or 0 }}</div>

                        <div>
                          <input class="stock-input"
                                type="number"
                                name="add_stock"
                                min="1"
                                step="1"
                                placeholder="e.g. 10"
                                required>
                        </div>

                        <div>
                          <button class="stock-btn" type="submit">Add stock</button>
                        </div>
                      </form>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="empty">No products found. Add products first.</div>
                {% endif %}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script>
      (function(){
        // -------------------------
        // Tabs (sheets)
        // -------------------------
        const tabsRoot = document.getElementById("adminTabs");
        if(!tabsRoot) return;

        const tabBtns = Array.from(tabsRoot.querySelectorAll(".tab-btn"));
       const panels = {
          orders: document.getElementById("panel-orders"),
          products: document.getElementById("panel-products"),
          messages: document.getElementById("panel-messages"),
          addstock: document.getElementById("panel-addstock"),
        };

        function activate(tab){
          tabBtns.forEach(b => {
            const on = b.dataset.tab === tab;
            b.setAttribute("aria-selected", on ? "true" : "false");
          });
          Object.keys(panels).forEach(k => {
            if(!panels[k]) return;
            panels[k].classList.toggle("active", k === tab);
          });
          try{ localStorage.setItem("admin_active_tab", tab); }catch(e){}
        }

        tabBtns.forEach(btn => btn.addEventListener("click", () => activate(btn.dataset.tab)));

        // restore last tab
        try{
          const last = localStorage.getItem("admin_active_tab");
          if(last && panels[last]) activate(last);
        }catch(e){}

        // quick jump
        document.getElementById("jumpProducts")?.addEventListener("click", () => activate("products"));

        // -------------------------
        // Helpers: filter list
        // -------------------------
        function wireSearchAndFilter(opts){
          const {searchInput, statusSelect, listRoot, cardSelector, extraApply} = opts;
          if(!listRoot) return;

          function apply(){
            const q = (searchInput?.value || "").trim().toLowerCase();
            const st = (statusSelect?.value || "").trim();
            const cards = Array.from(listRoot.querySelectorAll(cardSelector));

            cards.forEach(card => {
              const hay = (card.getAttribute("data-search") || "");
              const cst = (card.getAttribute("data-status") || "");
              const okQ = !q || hay.includes(q);
              const okS = !st || cst === st;

              let okE = true;
              if(typeof extraApply === "function"){
                okE = extraApply(card);
              }

              card.style.display = (okQ && okS && okE) ? "" : "none";
            });
          }

          searchInput?.addEventListener("input", apply);
          statusSelect?.addEventListener("change", apply);
          apply();
        }

        // Orders filter
        wireSearchAndFilter({
          searchInput: document.getElementById("orderSearch"),
          statusSelect: document.getElementById("orderStatusFilter"),
          listRoot: document.getElementById("ordersList"),
          cardSelector: ".order-card"
        });

        // Messages filter
        wireSearchAndFilter({
          searchInput: document.getElementById("msgSearch"),
          statusSelect: document.getElementById("msgStatusFilter"),
          listRoot: document.getElementById("msgsList"),
          cardSelector: ".msg-card"
        });

        // Add Stock filter (NEW)
        (function(){
  const listRoot = document.getElementById("stockList");
  const searchInput = document.getElementById("stockSearch");
  if(!listRoot || !searchInput) return;

  function apply(){
    const q = (searchInput.value || "").trim().toLowerCase();
    const rows = Array.from(listRoot.querySelectorAll(".stock-row"));
    rows.forEach(r => {
      const hay = (r.getAttribute("data-search") || "");
      r.style.display = (!q || hay.includes(q)) ? "" : "none";
    });
  }

  searchInput.addEventListener("input", apply);
  apply();
})();

        // Products filter (NEW)
        (function(){
          const listRoot = document.getElementById("prodList");
          if(!listRoot) return;

          const searchInput = document.getElementById("prodSearch");
          const catSelect = document.getElementById("prodCategoryFilter");
          const statusSelect = document.getElementById("prodStatusFilter");

          function apply(){
            const q = (searchInput?.value || "").trim().toLowerCase();
            const cat = (catSelect?.value || "").trim();
            const st = (statusSelect?.value || "").trim(); // Active / Inactive / Out

            const cards = Array.from(listRoot.querySelectorAll(".prod-card"));
            cards.forEach(card => {
              const hay = (card.getAttribute("data-search") || "");
              const ccat = (card.getAttribute("data-category") || "");
              const cst = (card.getAttribute("data-status") || "");
              const cstock = (card.getAttribute("data-stock") || "In");

              const okQ = !q || hay.includes(q);
              const okC = !cat || ccat === cat;

              let okS = true;
              if(st === "Active") okS = (cst === "Active");
              else if(st === "Inactive") okS = (cst === "Inactive");
              else if(st === "Out") okS = (cstock === "Out");

              card.style.display = (okQ && okC && okS) ? "" : "none";
            });
          }

          searchInput?.addEventListener("input", apply);
          catSelect?.addEventListener("change", apply);
          statusSelect?.addEventListener("change", apply);
          apply();
        })();

        // -------------------------
        // Expand/Collapse details
        // -------------------------
        function setDetailsOpen(root, selector, open){
          if(!root) return;
          root.querySelectorAll(selector).forEach(d => d.open = !!open);
        }

        document.getElementById("collapseAllOrders")?.addEventListener("click", () => {
          setDetailsOpen(document.getElementById("panel-orders"), "details.order-items", false);
        });
        document.getElementById("expandAllOrders")?.addEventListener("click", () => {
          setDetailsOpen(document.getElementById("panel-orders"), "details.order-items", true);
        });

        document.getElementById("collapseAllMsgs")?.addEventListener("click", () => {
          setDetailsOpen(document.getElementById("panel-messages"), "details.msg-body", false);
        });
        document.getElementById("expandAllMsgs")?.addEventListener("click", () => {
          setDetailsOpen(document.getElementById("panel-messages"), "details.msg-body", true);
        });

        // -------------------------
        // Add Product Card toggle + image preview
        // -------------------------
        const addCard = document.getElementById("addProductCard");
        const toggleBtn = document.getElementById("toggleAddProduct");
        const closeBtn = document.getElementById("closeAddProduct");
        const imgInput = document.getElementById("prodImage");

        const preview = document.getElementById("prodPreview");
        const previewImg = document.getElementById("prodPreviewImg");
        const previewMeta = document.getElementById("prodPreviewMeta");

        function closeAdd(){
          if(addCard) addCard.style.display = "none";
        }

        toggleBtn?.addEventListener("click", () => {
          if(!addCard) return;
          const isOpen = addCard.style.display !== "none";
          addCard.style.display = isOpen ? "none" : "";
          if(!isOpen){
            addCard.scrollIntoView({behavior:"smooth", block:"start"});
          }
        });
        closeBtn?.addEventListener("click", closeAdd);

        imgInput?.addEventListener("change", (e) => {
          const f = e.target.files && e.target.files[0];
          if(!f){ preview.style.display = "none"; return; }

          const url = URL.createObjectURL(f);
          previewImg.src = url;
          preview.style.display = "";

          const sizeKb = Math.round((f.size || 0) / 1024);
          previewMeta.innerHTML =
            "<div style='text-transform:uppercase;letter-spacing:.14em;font-size:11px;margin-bottom:6px;'>Image selected</div>" +
            "<div><strong>Name:</strong> " + (f.name || "-") + "</div>" +
            "<div><strong>Size:</strong> " + sizeKb + " KB</div>" +
            "<div><strong>Type:</strong> " + (f.type || "-") + "</div>";
        });

        document.getElementById("resetProdForm")?.addEventListener("click", () => {
          if(preview) preview.style.display = "none";
          if(previewImg) previewImg.removeAttribute("src");
        });

         (function(){
            const front = document.getElementById("prodImageFront");
            const back  = document.getElementById("prodImageBack");
            const wrap  = document.getElementById("prodPreview");
            const imgF  = document.getElementById("prodPreviewImgFront");
            const imgB  = document.getElementById("prodPreviewImgBack");

            function show(){
              if(!wrap) return;
              const has = (front?.files?.[0] || back?.files?.[0]);
              wrap.style.display = has ? "" : "none";
            }

            function read(file, img){
              if(!file || !img) return;
              const url = URL.createObjectURL(file);
              img.src = url;
            }

            front?.addEventListener("change", () => {
              read(front.files[0], imgF);
              show();
            });

            back?.addEventListener("change", () => {
              read(back.files[0], imgB);
              show();
            });
          })();
      })();
    </script>
  </section>
</main>
{% endblock %}
