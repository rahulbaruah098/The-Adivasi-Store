{% extends "base.html" %}

{% block content %}
<main>

  <section class="section shop-page">
    <style>

      .prod-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transition:opacity .35s ease; }
      .product-media{ position:relative; overflow:hidden; }
      .product-img{
        position:absolute; inset:0;
        width:100%; height:100%;
        object-fit:cover;
        transition:opacity .35s ease;
      }
      .product-img-primary{ opacity:1; }
      .product-img-hover{ opacity:0; }
      .product-card:hover .product-img-primary{ opacity:0; }
      .product-card:hover .product-img-hover{ opacity:1; }
      :root{
        --bg-cream:#f4ece0;
        --bg-deep:#1b130e;
        --ink:#22150e;
        --accent:#7b3321;
        --accent-soft:#b0673d;
        --line-soft:rgba(60,38,22,0.22);
        --shadow-soft:0 18px 38px rgba(0,0,0,0.28);
        --shadow-card:0 10px 26px rgba(0,0,0,0.22);
        --radius-card:20px;
        --transition-fast:0.2s ease;
        --transition-med:0.35s ease;
      }

      img{max-width:100%;display:block;}
      a{text-decoration:none;color:inherit;}

      /* ================= HERO (SHOP) =================
         ✅ Full-bleed (left-to-right) even inside container layouts
      ================================================= */
      .hero-shop{
        position:relative;
        min-height:90vh;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:140px 20px 80px;
        color:#fff;
        text-align:center;
        overflow:hidden;
        --hero-offset:0px;

        /* ✅ full width stretch */
        width:100vw;
        margin-left:calc(50% - 50vw);
        margin-right:calc(50% - 50vw);
      }
      .hero-shop::before{
        content:"";
        position:absolute;
        inset:0;
        background-image:
          linear-gradient(to top, rgba(0,0,0,0.72), rgba(0,0,0,0.25)),
          url("static/images/shophero.jpg");
        background-size:cover;
        background-position:center calc(0px + var(--hero-offset));
        transition:background-position 0.12s linear;
        z-index:-2;
      }
      .hero-shop::after{
        content:"";
        position:absolute;
        inset:0;
        background:
          radial-gradient(circle at 18% 6%,rgba(255,255,255,0.25),transparent 55%),
          radial-gradient(circle at 82% 92%,rgba(255,255,255,0.18),transparent 60%);
        mix-blend-mode:screen;
        opacity:0.8;
        z-index:-1;
      }
      .hero-shop .hero-inner{
        max-width:840px;
        animation:hero-reveal 1.1s ease-out both;
      }
      @keyframes hero-reveal{
        0%{opacity:0;transform:translateY(40px);}
        100%{opacity:1;transform:translateY(0);}
      }
      .hero-shop .hero-kicker{
        font-family:"Fjalla One",sans-serif;
        letter-spacing:0.25em;
        font-size:11px;
        text-transform:uppercase;
        margin-bottom:14px;
      }
      .hero-shop .hero-title{
        font-size:clamp(44px,5.4vw,64px);
        line-height:0.95;
        text-transform:uppercase;
        margin-bottom:14px;
        letter-spacing:0.16em;
      }
      .hero-shop .hero-sub{
        max-width:620px;
        margin:0 auto 26px;
        font-size:14px;
      }
      .hero-shop .hero-cta-row{
        display:flex;
        justify-content:center;
        gap:16px;
        flex-wrap:wrap;
      }
      .hero-shop .hero-cta{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding:11px 34px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.9);
        background:rgba(0,0,0,0.45);
        font-family:"Fjalla One",sans-serif;
        font-size:11px;
        letter-spacing:0.2em;
        text-transform:uppercase;
        transition:background var(--transition-fast),color var(--transition-fast),transform var(--transition-fast),box-shadow var(--transition-fast);
      }
      .hero-shop .hero-cta:hover{
        background:#fff;
        color:#000;
        transform:translateY(-2px);
        box-shadow:var(--shadow-soft);
      }
      .hero-shop .hero-cta-secondary{
        border-style:dashed;
        opacity:0.9;
      }

      /* ================= CATEGORY / SHELL ================= */

      .shop-shell{
        padding:40px 60px 80px;
        background:
          repeating-linear-gradient(135deg,rgba(167,124,75,0.06) 0,rgba(167,124,75,0.06) 14px,transparent 14px,transparent 28px),
          #f5ede2;
      }
      .shop-header{
        max-width:950px;
        margin:0 auto 28px;
        text-align:center;
      }
      .shop-kicker{
        font-family:"Fjalla One",sans-serif;
        letter-spacing:0.22em;
        font-size:11px;
        text-transform:uppercase;
        color:#8a6b46;
        margin-bottom:6px;
      }
      .shop-title{
        font-size:26px;
        letter-spacing:0.14em;
        text-transform:uppercase;
        margin-bottom:8px;
      }
      .shop-sub{
        font-size:13px;
        color:#6b5a48;
      }

      .shop-category-pills{
        margin:26px auto 8px;
        max-width:960px;
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        justify-content:center;
      }
      .shop-pill{
        border-radius:999px;
        border:1px solid rgba(109,81,54,0.35);
        padding:5px 14px;
        font-size:11px;
        letter-spacing:0.18em;
        text-transform:uppercase;
        font-family:"Fjalla One",sans-serif;
        background:rgba(255,255,255,0.85);
        cursor:pointer;
        position:relative;
        overflow:hidden;
        transition:background 0.18s ease,transform 0.18s ease,box-shadow 0.18s.ease;
      }
      .shop-pill span{
        position:relative;
        z-index:1;
      }
      .shop-pill::before{
        content:"";
        position:absolute;
        inset:0;
        background:linear-gradient(120deg,rgba(196,119,65,0.2),rgba(91,51,32,0.7));
        opacity:0;
        transition:opacity 0.18s ease;
      }
      .shop-pill:hover{
        transform:translateY(-1px);
        box-shadow:0 9px 18px rgba(0,0,0,0.18);
      }
      .shop-pill:hover::before{
        opacity:1;
      }
      .shop-pill:hover span{
        color:#fff;
      }

      /* ================= SHOP ROWS ================= */

      .shop-row{
        margin:42px auto 0;
        max-width:1180px;
      }
      .shop-row-header{
        display:flex;
        align-items:flex-end;
        justify-content:space-between;
        gap:10px;
        margin-bottom:16px;
      }
      .shop-row-title{
        font-size:16px;
        letter-spacing:0.18em;
        text-transform:uppercase;
      }
      .shop-row-sub{
        font-size:12px;
        color:#7a6651;
      }
      .shop-row-kicker{
        font-family:"Fjalla One",sans-serif;
        font-size:11px;
        letter-spacing:0.2em;
        text-transform:uppercase;
        color:#b0673d;
        margin-bottom:2px;
      }

      .product-track{
        position:relative;
        display:flex;
        gap:22px;
        overflow-x:auto;
        padding-bottom:8px;
        scroll-behavior:smooth;
        scroll-snap-type:x mandatory;
      }
      .product-track::-webkit-scrollbar{
        height:6px;
      }
      .product-track::-webkit-scrollbar-track{
        background:rgba(0,0,0,0.03);
      }
      .product-track::-webkit-scrollbar-thumb{
        background:rgba(73,52,33,0.4);
        border-radius:999px;
      }

      .product-card{
        min-width:230px;
        max-width:240px;
        background:#efe4d7;
        border-radius:var(--radius-card);
        border:1px solid rgba(126,99,70,0.4);
        box-shadow:var(--shadow-card);
        scroll-snap-align:start;
        overflow:hidden;
        display:flex;
        flex-direction:column;
        position:relative;
        transition:transform 0.22s ease,box-shadow 0.22s ease;
      }
      .product-card:hover{
        transform:translateY(-6px) rotate(-0.4deg);
        box-shadow:0 18px 36px rgba(0,0,0,0.32);
      }

      .product-media{
        position:relative;
        aspect-ratio:3/4;
        background:#d7cbbd;
        overflow:hidden;
      }
      .product-img{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        object-fit:cover;
        transition:opacity var(--transition-med),transform 0.4s.ease;
      }
      .product-img-primary{opacity:1;}
      .product-card:hover .product-img-primary{
        opacity:0;
        transform:scale(1.04);
      }
      .product-img-hover{
        opacity:0;
        transform:scale(1.04);
      }
      .product-card:hover .product-img-hover{
        opacity:1;
        transform:scale(1.02);
      }

      .product-badge{
        position:absolute;
        top:10px;
        left:10px;
        padding:4px 9px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.85);
        background:rgba(51,30,20,0.72);
        color:#fff7e6;
        font-family:"Fjalla One",sans-serif;
        font-size:10px;
        letter-spacing:0.18em;
        text-transform:uppercase;
      }

      .product-add{
        position:absolute;
        right:10px;
        bottom:10px;
        width:30px;
        height:30px;
        border-radius:999px;
        border:none;
        background:rgba(255,255,255,0.97);
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        box-shadow:0 6px 14px rgba(0,0,0,0.28);
        transition:transform 0.18s ease,box-shadow 0.18s ease;
      }
      .product-add svg{width:18px;height:18px;}
      .product-add path{
        stroke:#24150f;
        stroke-width:1.6;
        fill:none;
        stroke-linecap:round;
        stroke-linejoin:round;
      }
      .product-add:hover{
        transform:translateY(-2px);
        box-shadow:0 9px 20px rgba(0,0,0,0.38);
      }

      .product-body{
        padding:11px 14px 13px;
        display:flex;
        flex-direction:column;
        gap:3px;
      }
      .product-category{
        font-size:10px;
        letter-spacing:0.18em;
        text-transform:uppercase;
        color:#7c6550;
        font-family:"Fjalla One",sans-serif;
      }
      .product-name{
        font-size:13px;
        letter-spacing:0.11em;
        text-transform:uppercase;
        margin-top:3px;
      }
      .product-meta-row{
        display:flex;
        justify-content:space-between;
        align-items:flex-end;
        margin-top:4px;
        font-size:12px;
      }
      .product-price{
        font-family:"Inter",sans-serif;
      }
      .product-price-label{
        letter-spacing:0.16em;
        text-transform:uppercase;
        font-size:10px;
        margin-right:2px;
      }
      .product-link{
        font-size:11px;
        letter-spacing:0.16em;
        text-transform:uppercase;
        border-bottom:1px solid rgba(40,26,18,0.4);
      }
      .product-link:hover{
        border-bottom-color:rgba(40,26,18,0.9);
      }

      /* ✨ Added-to-cart micro-animation (shop page) */
      .product-card.cart-added .product-add{
        animation:shop-cart-pop .55s ease-out;
      }
      .product-added-tag{
        position:absolute;
        left:12px;
        bottom:12px;
        padding:4px 10px;
        border-radius:999px;
        background:rgba(0,0,0,0.86);
        color:#fff;
        font-size:10px;
        letter-spacing:.16em;
        text-transform:uppercase;
        font-family:"Fjalla One",sans-serif;
        pointer-events:none;
        opacity:0;
        transform:translateY(8px) scale(.9);
        animation:shop-tag-pop .7s ease-out forwards;
      }
      @keyframes shop-cart-pop{
        0%{transform:translateY(0) scale(1);}
        35%{transform:translateY(-4px) scale(1.15) rotate(-4deg);}
        70%{transform:translateY(1px) scale(.96) rotate(2deg);}
        100%{transform:translateY(0) scale(1);}
      }
      @keyframes shop-tag-pop{
        0%{opacity:0;transform:translateY(8px) scale(.9);}
        30%{opacity:1;transform:translateY(0) scale(1);}
        100%{opacity:0;transform:translateY(-10px) scale(.95);}
      }

      /* ================= RESPONSIVE ================= */

      @media (max-width:1100px){
        .shop-shell{padding-inline:32px;}
      }

      @media (max-width:880px){
        .shop-shell{padding-inline:22px;}
        .hero-shop{padding-top:130px;}
      }

      @media (max-width:640px){
        .hero-shop{padding:120px 16px 70px;}
        .shop-shell{padding:34px 16px 70px;}
        .product-card{min-width:210px;max-width:210px;}
        .shop-row-header{
          flex-direction:column;
          align-items:flex-start;
        }
      }
    </style>

    <!-- =============== HERO =============== -->
    <section class="hero hero-shop" id="hero">
      <div class="hero-inner">
        <div class="hero-kicker">Adivasi Handwoven Collective</div>
        <h1 class="hero-title">Crafted in Culture</h1>
        <p class="hero-sub">
          From gamusa borders and tribal motifs to soft everyday wraps, each piece is woven with stories from the
          Adivasi heartlands. Discover clothing, ornaments and essentials that carry our colours forward.
        </p>
        <div class="hero-cta-row">
          <a href="#shop" class="hero-cta">Shop the collection</a>
          <a href="#ornaments-row" class="hero-cta hero-cta-secondary">View ornaments edit</a>
        </div>
      </div>
    </section>

{# ===================== UPDATED SHOP SHELL (DB hover supported) ===================== #}

    <!-- =============== SHOP SHELL =============== -->
    <section class="shop-shell" id="shop">
      <div class="shop-header">
        <div class="shop-kicker">The Adivasi Store · Shop</div>
        <h2 class="shop-title">Weaves, stories & everyday heirlooms</h2>
        <p class="shop-sub">
          Curated rows by category – women’s drapes, men’s woven layers, kids’ festive outfits,
          ornaments, and small accessories inspired by traditional patterns.
          Scroll sideways in each row or let them glide on their own.
        </p>
      </div>

      <!-- Category pills -->
      <div class="shop-category-pills">
        <button class="shop-pill" data-jump="#women-row"><span>Women</span></button>
        <button class="shop-pill" data-jump="#men-row"><span>Men</span></button>
        <button class="shop-pill" data-jump="#kids-row"><span>Kids</span></button>
        <button class="shop-pill" data-jump="#ornaments-row"><span>Ornaments</span></button>
        <button class="shop-pill" data-jump="#accessories-row"><span>Accessories</span></button>
      </div>

      {# --------------------------------------------
        Split DB products into gender/sections
        -------------------------------------------- #}
      {% set women_db = [] %}
      {% set men_db = [] %}
      {% set kids_db = [] %}
      {% set ornaments_db = [] %}
      {% set accessories_db = [] %}

      {% for p in (db_products or []) %}
        {% set cat = (p.category or '')|lower %}
        {# women keywords #}
        {% if 'saree' in cat or 'women' in cat or 'wrap' in cat or 'stole' in cat or 'dupatta' in cat %}
          {% set _ = women_db.append(p) %}
        {# men keywords #}
        {% elif 'men' in cat or 'shirt' in cat or 'bundi' in cat or 'bandi' in cat or 'gamusa' in cat %}
          {% set _ = men_db.append(p) %}
        {# kids keywords #}
        {% elif 'kid' in cat or 'kids' in cat or 'child' in cat %}
          {% set _ = kids_db.append(p) %}
        {# ornaments keywords #}
        {% elif 'ornament' in cat or 'jewel' in cat or 'bead' in cat or 'brass' in cat %}
          {% set _ = ornaments_db.append(p) %}
        {# fallback -> accessories #}
        {% else %}
          {% set _ = accessories_db.append(p) %}
        {% endif %}
      {% endfor %}

      {# ==========================================================
        ✅ WOMEN
        ========================================================== #}
      <section class="shop-row" id="women-row">
        <header class="shop-row-header">
          <div>
            <div class="shop-row-kicker">woven for her</div>
            <h3 class="shop-row-title">Women · Sarees, Bags & Wraps</h3>
          </div>
          <p class="shop-row-sub">Soft handloom textures, Adivasi borders and everyday silhouettes.</p>
        </header>

        <div class="product-track" data-autoslide="false">
          {% for p in women_db %}
            {% set front = (p.image_url or '') %}
            {% set hover = (p.image_hover_url or front) %}

            <article class="product-card"
                    data-detail-url="{{ url_for('product_detail', product_id=(p.slug or p.id)) }}">
              <div class="product-media">
                {% if p.stock is not none and p.stock <= 0 %}
                  <span class="product-badge">Out of stock</span>
                {% endif %}

                <img class="product-img product-img-primary" src="{{ front }}" alt="{{ p.name }}">
                <img class="product-img product-img-hover"   src="{{ hover }}" alt="{{ p.name }}">

                <button class="product-add"
                        data-id="{{ p.slug or p.id }}"
                        data-product-db-id="{{ p.id }}"
                        data-name="{{ p.name }}"
                        data-price="{{ p.price }}"
                        data-image="{{ front }}"
                        {% if p.stock is not none and p.stock <= 0 %}disabled style="opacity:.55;pointer-events:none"{% endif %}>
                  <svg viewBox="0 0 24 24">
                    <path d="M8 9c0-2.2 1.8-4 4-4s4 1.8 4 4"></path>
                    <path d="M7 9h10l-1 9H8L7 9z"></path>
                  </svg>
                </button>
              </div>

              <div class="product-body">
                <div class="product-category">{{ p.category }}</div>
                <div class="product-name">{{ p.name }}</div>

                <div class="product-meta-row">
                  <div class="product-price"><span class="product-price-label">Rs.</span> {{ p.price }}</div>
                  <a href="#" class="product-link" onclick="location=this.closest('.product-card').dataset.detailUrl">View</a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>

      {# ==========================================================
        ✅ MEN
        ========================================================== #}
      <section class="shop-row" id="men-row">
        <header class="shop-row-header">
          <div>
            <div class="shop-row-kicker">for him</div>
            <h3 class="shop-row-title">Men · Shirts, Bandi & Gamusa</h3>
          </div>
          <p class="shop-row-sub">Clean cuts layered with woven borders, perfect for travel and gatherings.</p>
        </header>

        <div class="product-track" data-autoslide="false">
          {% for p in men_db %}
            {% set front = (p.image_url or '') %}
            {% set hover = (p.image_hover_url or front) %}

            <article class="product-card"
                    data-detail-url="{{ url_for('product_detail', product_id=(p.slug or p.id)) }}">
              <div class="product-media">
                {% if p.stock is not none and p.stock <= 0 %}
                  <span class="product-badge">Out of stock</span>
                {% endif %}

                <img class="product-img product-img-primary" src="{{ front }}" alt="{{ p.name }}">
                <img class="product-img product-img-hover"   src="{{ hover }}" alt="{{ p.name }}">

                <button class="product-add"
                        data-id="{{ p.slug or p.id }}"
                        data-product-db-id="{{ p.id }}"
                        data-name="{{ p.name }}"
                        data-price="{{ p.price }}"
                        data-image="{{ front }}"
                        {% if p.stock is not none and p.stock <= 0 %}disabled style="opacity:.55;pointer-events:none"{% endif %}>
                  <svg viewBox="0 0 24 24">
                    <path d="M8 9c0-2.2 1.8-4 4-4s4 1.8 4 4"></path>
                    <path d="M7 9h10l-1 9H8L7 9z"></path>
                  </svg>
                </button>
              </div>

              <div class="product-body">
                <div class="product-category">{{ p.category }}</div>
                <div class="product-name">{{ p.name }}</div>

                <div class="product-meta-row">
                  <div class="product-price"><span class="product-price-label">Rs.</span> {{ p.price }}</div>
                  <a href="#" class="product-link" onclick="location=this.closest('.product-card').dataset.detailUrl">View</a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>

      {# ==========================================================
        ✅ KIDS
        ========================================================== #}
      <section class="shop-row" id="kids-row">
        <header class="shop-row-header">
          <div>
            <div class="shop-row-kicker">little ones</div>
            <h3 class="shop-row-title">Kids · Festive sets & wraps</h3>
          </div>
          <p class="shop-row-sub">Soft, fuss-free outfits with playful use of motifs and colour.</p>
        </header>

        <div class="product-track" data-autoslide="false">
          {% for p in kids_db %}
            {% set front = (p.image_url or '') %}
            {% set hover = (p.image_hover_url or front) %}

            <article class="product-card"
                    data-detail-url="{{ url_for('product_detail', product_id=(p.slug or p.id)) }}">
              <div class="product-media">
                {% if p.stock is not none and p.stock <= 0 %}
                  <span class="product-badge">Out of stock</span>
                {% endif %}

                <img class="product-img product-img-primary" src="{{ front }}" alt="{{ p.name }}">
                <img class="product-img product-img-hover"   src="{{ hover }}" alt="{{ p.name }}">

                <button class="product-add"
                        data-id="{{ p.slug or p.id }}"
                        data-product-db-id="{{ p.id }}"
                        data-name="{{ p.name }}"
                        data-price="{{ p.price }}"
                        data-image="{{ front }}"
                        {% if p.stock is not none and p.stock <= 0 %}disabled style="opacity:.55;pointer-events:none"{% endif %}>
                  <svg viewBox="0 0 24 24">
                    <path d="M8 9c0-2.2 1.8-4 4-4s4 1.8 4 4"></path>
                    <path d="M7 9h10l-1 9H8L7 9z"></path>
                  </svg>
                </button>
              </div>

              <div class="product-body">
                <div class="product-category">{{ p.category }}</div>
                <div class="product-name">{{ p.name }}</div>

                <div class="product-meta-row">
                  <div class="product-price"><span class="product-price-label">Rs.</span> {{ p.price }}</div>
                  <a href="#" class="product-link" onclick="location=this.closest('.product-card').dataset.detailUrl">View</a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>

      {# ==========================================================
        ✅ ORNAMENTS
        ========================================================== #}
      <section class="shop-row" id="ornaments-row">
        <header class="shop-row-header">
          <div>
            <div class="shop-row-kicker">ornaments</div>
            <h3 class="shop-row-title">Ornaments · Beads, Brass & Threads</h3>
          </div>
          <p class="shop-row-sub">Inspired by Adivasi jewellery – layered beads, brass details and thread tassels.</p>
        </header>

        <div class="product-track" data-autoslide="false">
          {% for p in ornaments_db %}
            {% set front = (p.image_url or '') %}
            {% set hover = (p.image_hover_url or front) %}

            <article class="product-card"
                    data-detail-url="{{ url_for('product_detail', product_id=(p.slug or p.id)) }}">
              <div class="product-media">
                {% if p.stock is not none and p.stock <= 0 %}
                  <span class="product-badge">Out of stock</span>
                {% endif %}

                <img class="product-img product-img-primary" src="{{ front }}" alt="{{ p.name }}">
                <img class="product-img product-img-hover"   src="{{ hover }}" alt="{{ p.name }}">

                <button class="product-add"
                        data-id="{{ p.slug or p.id }}"
                        data-product-db-id="{{ p.id }}"
                        data-name="{{ p.name }}"
                        data-price="{{ p.price }}"
                        data-image="{{ front }}"
                        {% if p.stock is not none and p.stock <= 0 %}disabled style="opacity:.55;pointer-events:none"{% endif %}>
                  <svg viewBox="0 0 24 24">
                    <path d="M8 9c0-2.2 1.8-4 4-4s4 1.8 4 4"></path>
                    <path d="M7 9h10l-1 9H8L7 9z"></path>
                  </svg>
                </button>
              </div>

              <div class="product-body">
                <div class="product-category">{{ p.category }}</div>
                <div class="product-name">{{ p.name }}</div>

                <div class="product-meta-row">
                  <div class="product-price"><span class="product-price-label">Rs.</span> {{ p.price }}</div>
                  <a href="#" class="product-link" onclick="location=this.closest('.product-card').dataset.detailUrl">View</a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>

      {# ==========================================================
        ✅ ACCESSORIES
        ========================================================== #}
      <section class="shop-row" id="accessories-row">
        <header class="shop-row-header">
          <div>
            <div class="shop-row-kicker">small things</div>
            <h3 class="shop-row-title">Accessories · Stoles, Belts & More</h3>
          </div>
          <p class="shop-row-sub">Smaller pieces with big character – perfect Adivasi gifts.</p>
        </header>

        <div class="product-track" data-autoslide="false">
          {% for p in accessories_db %}
            {% set front = (p.image_url or '') %}
            {% set hover = (p.image_hover_url or front) %}

            <article class="product-card"
                    data-detail-url="{{ url_for('product_detail', product_id=(p.slug or p.id)) }}">
              <div class="product-media">
                {% if p.stock is not none and p.stock <= 0 %}
                  <span class="product-badge">Out of stock</span>
                {% endif %}

                <img class="product-img product-img-primary" src="{{ front }}" alt="{{ p.name }}">
                <img class="product-img product-img-hover"   src="{{ hover }}" alt="{{ p.name }}">

                <button class="product-add"
                        data-id="{{ p.slug or p.id }}"
                        data-product-db-id="{{ p.id }}"
                        data-name="{{ p.name }}"
                        data-price="{{ p.price }}"
                        data-image="{{ front }}"
                        {% if p.stock is not none and p.stock <= 0 %}disabled style="opacity:.55;pointer-events:none"{% endif %}>
                  <svg viewBox="0 0 24 24">
                    <path d="M8 9c0-2.2 1.8-4 4-4s4 1.8 4 4"></path>
                    <path d="M7 9h10l-1 9H8L7 9z"></path>
                  </svg>
                </button>
              </div>

              <div class="product-body">
                <div class="product-category">{{ p.category }}</div>
                <div class="product-name">{{ p.name }}</div>

                <div class="product-meta-row">
                  <div class="product-price"><span class="product-price-label">Rs.</span> {{ p.price }}</div>
                  <a href="#" class="product-link" onclick="location=this.closest('.product-card').dataset.detailUrl">View</a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>

    </section>

<script>
              // Hero parallax
              const heroSection = document.querySelector(".hero-shop");
              window.addEventListener("scroll", () => {
                if (!heroSection) return;
                const offset = window.scrollY * 0.25;
                heroSection.style.setProperty("--hero-offset", offset + "px");
              }, { passive: true });

              // Category pills smooth scroll
              document.querySelectorAll(".shop-pill").forEach(pill => {
                pill.addEventListener("click", () => {
                  const target = pill.getAttribute("data-jump");
                  if (!target) return;
                  const el = document.querySelector(target);
                  if (el) {
                    const rect = el.getBoundingClientRect();
                    const absoluteY = window.scrollY + rect.top - 80; // header height
                    window.scrollTo({ top: absoluteY, behavior: "smooth" });
                  }
                });
              });

              // ✅ FIX: Product detail navigation (drag-safe inside horizontal product-track)
              (function () {
                let startX = 0, startY = 0;
                let isDown = false;

                document.querySelectorAll(".product-card").forEach((card) => {
                  card.style.cursor = "pointer";

                  card.addEventListener("pointerdown", (e) => {
                    if (e.target.closest(".product-add")) return;
                    if (e.target.closest("a")) return;
                    isDown = true;
                    startX = e.clientX;
                    startY = e.clientY;
                  });

                  card.addEventListener("pointerup", (e) => {
                    if (!isDown) return;
                    isDown = false;

                    if (e.target.closest(".product-add")) return;
                    if (e.target.closest("a")) return;

                    const dx = Math.abs(e.clientX - startX);
                    const dy = Math.abs(e.clientY - startY);

                    // If user dragged to scroll horizontally, do not navigate
                    if (dx > 6 || dy > 6) return;

                    const url = card.getAttribute("data-detail-url");
                    if (!url) return;

                    // Keep your image query append logic (safe)
                    const primary = card.querySelector(".product-img-primary")?.getAttribute("src") || "";
                    const hover = card.querySelector(".product-img-hover")?.getAttribute("src") || "";

                    const hasQuery = url.includes("?");
                    const hasImg = url.includes("img=");
                    let finalUrl = url;

                    const norm = (p) => {
                      if (!p) return "";
                      if (p.startsWith("http://") || p.startsWith("https://") || p.startsWith("/")) return p;
                      return "/" + p;
                    };

                    if (primary && !hasImg) {
                      finalUrl += (hasQuery ? "&" : "?") + "img=" + encodeURIComponent(norm(primary));
                      if (hover) finalUrl += "&hover=" + encodeURIComponent(norm(hover));
                    }

                    window.location.href = finalUrl;
                  });

                  card.addEventListener("pointercancel", () => { isDown = false; });
                  card.addEventListener("pointerleave", () => { isDown = false; });
                });
              })();

              // ✨ Show "Added to cart" tag + nav cart bounce
              function showCartAdded(card){
                if(!card) return;

                card.classList.add("cart-added");

                const oldTag = card.querySelector(".product-added-tag");
                if(oldTag) oldTag.remove();

                const tag = document.createElement("div");
                tag.className = "product-added-tag";
                tag.textContent = "Added to cart";
                card.appendChild(tag);

                const navCart = document.querySelector(".nav-cart");
                if(navCart){
                  navCart.classList.add("nav-cart--ping");
                  setTimeout(()=>navCart.classList.remove("nav-cart--ping"), 650);
                }

                setTimeout(()=>{
                  card.classList.remove("cart-added");
                  if(tag && tag.parentNode){
                    tag.parentNode.removeChild(tag);
                  }
                }, 900);
              }

              // ✅ Add-to-cart: now also sends product_db_id (CRITICAL for stock tracking)
              const addToCartBaseUrl = "{{ url_for('add_to_cart') }}";
              document.querySelectorAll(".product-add").forEach(btn => {
                btn.addEventListener("click", (e) => {
                  e.stopPropagation();

                  const card = btn.closest(".product-card");
                  if (!card) return;

                  const productId = btn.dataset.id || "";
                  if (!productId) return;

                  const productDbId = btn.dataset.productDbId || ""; // ✅ NEW

                  const productName =
                    btn.dataset.name ||
                    (card.querySelector(".product-name")?.textContent.trim()) ||
                    productId;

                  const rawPrice =
                    btn.dataset.price ||
                    (card.querySelector(".product-price")?.textContent) ||
                    "0";

                  // Clean e.g. "Rs. 2,490" -> "2490"
                  const cleanedPrice = String(rawPrice).replace(/[^\d.]/g, "");

                  const imgEl = card.querySelector(".product-img-primary");
                  const imgUrl = imgEl ? imgEl.src : "";

                  const params = new URLSearchParams({
                    product_id: productId,
                    name: productName,
                    price: cleanedPrice,
                    image: imgUrl
                  });

                  // ✅ include db id when present
                  if (productDbId) params.set("product_db_id", productDbId);

                  const url = addToCartBaseUrl + "?" + params.toString();

                  fetch(url, {
                    method: "GET",
                    credentials: "include"
                  }).catch(()=>{});

                  showCartAdded(card);
                });
              });

              // Auto sliding product tracks
              const tracks = document.querySelectorAll(".product-track[data-autoslide='true']");

              tracks.forEach(track => {
                const cards = track.querySelectorAll(".product-card");
                if (cards.length <= 1) return;

                let direction = 1;

                const timer = setInterval(() => {
                  const card = cards[0];
                  const step = card.getBoundingClientRect().width + 22;
                  const maxScroll = track.scrollWidth - track.clientWidth;

                  if (direction === 1) {
                    if (track.scrollLeft + step >= maxScroll - 5) {
                      direction = -1;
                    } else {
                      track.scrollBy({ left: step, behavior: "smooth" });
                    }
                  } else {
                    if (track.scrollLeft - step <= 0) {
                      direction = 1;
                    } else {
                      track.scrollBy({ left: -step, behavior: "smooth" });
                    }
                  }
                }, 3500);

                // Optional: if user interacts, stop autoslide
                const stop = () => clearInterval(timer);
                track.addEventListener("pointerdown", stop, { once: true });
                track.addEventListener("wheel", stop, { once: true, passive: true });
                track.addEventListener("touchstart", stop, { once: true, passive: true });
              });
    </script>

    <script>

    (function () {
      // ---- 1) Styles (injected once) ----
      if (!document.getElementById("pvx-style")) {
        const style = document.createElement("style");
        style.id = "pvx-style";
        style.textContent = `
          .pvx-overlay{
            position:fixed; inset:0; z-index:999999;
            background:rgba(0,0,0,.55);
            display:none;
            align-items:center; justify-content:center;
            padding:18px;
          }
          .pvx-overlay.pvx-open{ display:flex; }
          .pvx-modal{
            width:min(980px, 96vw);
            background:rgba(244,236,224,.98);
            border:1px solid rgba(126,99,70,0.45);
            border-radius:22px;
            box-shadow:0 26px 70px rgba(0,0,0,.45);
            overflow:hidden;
            transform:translateY(14px) scale(.985);
            opacity:0;
            transition:transform .22s ease, opacity .22s ease;
          }
          .pvx-overlay.pvx-open .pvx-modal{
            transform:translateY(0) scale(1);
            opacity:1;
          }
          .pvx-head{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            padding:14px 16px;
            background:linear-gradient(135deg, rgba(27,19,14,.08), rgba(176,103,61,.12));
            border-bottom:1px solid rgba(126,99,70,0.28);
          }
          .pvx-title{
            font-family:"Fjalla One",sans-serif;
            letter-spacing:.14em;
            text-transform:uppercase;
            font-size:13px;
            color:#22150e;
            margin:0;
          }
          .pvx-close{
            width:36px; height:36px;
            border-radius:999px;
            border:1px solid rgba(40,26,18,0.35);
            background:rgba(255,255,255,0.75);
            cursor:pointer;
            display:grid; place-items:center;
            transition:transform .18s ease, background .18s ease;
          }
          .pvx-close:hover{ transform:translateY(-1px); background:#fff; }
          .pvx-body{
            display:grid;
            grid-template-columns: 1.05fr .95fr;
            gap:0;
          }
          .pvx-media{
            position:relative;
            background:#d7cbbd;
            min-height:360px;
          }
          .pvx-img{
            width:100%;
            height:100%;
            min-height:360px;
            object-fit:cover;
            display:block;
          }
          .pvx-thumbs{
            position:absolute;
            left:12px; bottom:12px;
            display:flex; gap:10px;
          }
          .pvx-thumb{
            width:54px; height:66px;
            border-radius:12px;
            border:1px solid rgba(255,255,255,.85);
            overflow:hidden;
            cursor:pointer;
            background:rgba(0,0,0,.18);
            box-shadow:0 10px 20px rgba(0,0,0,.18);
            opacity:.9;
            transition:transform .15s ease, opacity .15s ease;
          }
          .pvx-thumb:hover{ transform:translateY(-2px); opacity:1; }
          .pvx-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
          .pvx-info{
            padding:18px 18px 20px;
            background:#efe4d7;
          }
          .pvx-kicker{
            font-family:"Fjalla One",sans-serif;
            font-size:11px;
            letter-spacing:.22em;
            text-transform:uppercase;
            color:#7c6550;
            margin-bottom:8px;
          }
          .pvx-name{
            font-size:18px;
            letter-spacing:.12em;
            text-transform:uppercase;
            margin:0 0 10px;
            color:#22150e;
          }
          .pvx-price{
            font-family:"Inter",sans-serif;
            color:#22150e;
            font-size:14px;
            margin:0 0 16px;
          }
          .pvx-actions{
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            align-items:center;
            margin-top:10px;
          }
          .pvx-btn{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            padding:11px 16px;
            border-radius:999px;
            border:1px solid rgba(40,26,18,0.35);
            background:rgba(255,255,255,0.85);
            cursor:pointer;
            font-family:"Fjalla One",sans-serif;
            font-size:11px;
            letter-spacing:.18em;
            text-transform:uppercase;
            transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
          }
          .pvx-btn:hover{
            transform:translateY(-2px);
            box-shadow:0 14px 30px rgba(0,0,0,.22);
            background:#fff;
          }
          .pvx-btn-primary{
            background:rgba(27,19,14,.92);
            color:#fff;
            border-color:rgba(27,19,14,.92);
          }
          .pvx-btn-primary:hover{ background:#1b130e; }
          .pvx-btn svg{ width:18px; height:18px; }
          .pvx-btn path{
            stroke:currentColor;
            stroke-width:1.6;
            fill:none;
            stroke-linecap:round;
            stroke-linejoin:round;
          }

          @media (max-width:820px){
            .pvx-body{ grid-template-columns: 1fr; }
            .pvx-media{ min-height:320px; }
            .pvx-img{ min-height:320px; }
          }
        `;
        document.head.appendChild(style);
      }

      // ---- 2) Modal HTML (injected once) ----
      let overlay = document.getElementById("pvx-overlay");
      if (!overlay) {
        overlay = document.createElement("div");
        overlay.className = "pvx-overlay";
        overlay.id = "pvx-overlay";
        overlay.innerHTML = `
          <div class="pvx-modal" role="dialog" aria-modal="true" aria-label="Product quick view">
            <div class="pvx-head">
              <p class="pvx-title">Quick View</p>
              <button class="pvx-close" type="button" aria-label="Close">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M6 6l12 12"></path>
                  <path d="M18 6L6 18"></path>
                </svg>
              </button>
            </div>
            <div class="pvx-body">
              <div class="pvx-media">
                <img class="pvx-img" alt="">
                <div class="pvx-thumbs" aria-label="Image thumbnails"></div>
              </div>
              <div class="pvx-info">
                <div class="pvx-kicker"></div>
                <h3 class="pvx-name"></h3>
                <p class="pvx-price"></p>
                <div class="pvx-actions">
                  <button class="pvx-btn pvx-btn-primary pvx-add" type="button">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M8 9c0-2.2 1.8-4 4-4s4 1.8 4 4"></path>
                      <path d="M7 9h10l-1 9H8L7 9z"></path>
                    </svg>
                    Add to Cart
                  </button>
                  <a class="pvx-btn pvx-open" href="#" aria-label="Open full product page">Open Full Page</a>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      }

      const els = {
        modal: overlay.querySelector(".pvx-modal"),
        close: overlay.querySelector(".pvx-close"),
        img: overlay.querySelector(".pvx-img"),
        thumbs: overlay.querySelector(".pvx-thumbs"),
        kicker: overlay.querySelector(".pvx-kicker"),
        name: overlay.querySelector(".pvx-name"),
        price: overlay.querySelector(".pvx-price"),
        add: overlay.querySelector(".pvx-add"),
        open: overlay.querySelector(".pvx-open")
      };

      const addToCartBaseUrl = "{{ url_for('add_to_cart') }}";

      function openModal() {
        overlay.classList.add("pvx-open");
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        overlay.classList.remove("pvx-open");
        document.body.style.overflow = "";
      }

      function setMainImage(src, alt) {
        els.img.src = src || "";
        els.img.alt = alt || "";
      }

      function renderThumbs(images, alt) {
        els.thumbs.innerHTML = "";
        images.filter(Boolean).forEach((src, i) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "pvx-thumb";
          btn.innerHTML = `<img src="${src}" alt="">`;
          btn.addEventListener("click", () => setMainImage(src, alt));
          els.thumbs.appendChild(btn);
          if (i === 0) setMainImage(src, alt);
        });
      }

      function addToCart(productId, productDbId, productName, price, imageUrl, originCard) {
        if (!productId) return;

        const cleanedPrice = String(price || "0").replace(/[^\d.]/g, "");
        const params = new URLSearchParams({
          product_id: productId,
          name: productName || productId,
          price: cleanedPrice,
          image: imageUrl || ""
        });

        // ✅ include db id when present
        if (productDbId) params.set("product_db_id", productDbId);

        const url = addToCartBaseUrl + "?" + params.toString();

        fetch(url, { method: "GET", credentials: "include" }).catch(() => {});
        if (typeof showCartAdded === "function") {
          showCartAdded(originCard);
        }
      }

      // Close handlers
      els.close.addEventListener("click", closeModal);
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) closeModal();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && overlay.classList.contains("pvx-open")) closeModal();
      });

      // Intercept "View" clicks
      document.addEventListener("click", (e) => {
        const link = e.target.closest(".product-link");
        if (!link) return;

        const card = link.closest(".product-card");
        if (!card) return;

        e.preventDefault();

        const primaryImg = card.querySelector(".product-img-primary")?.src || "";
        const hoverImg = card.querySelector(".product-img-hover")?.src || "";
        const productName = card.querySelector(".product-name")?.textContent?.trim() || "Product";
        const productCat = card.querySelector(".product-category")?.textContent?.trim() || "";
        const productPriceText = card.querySelector(".product-price")?.textContent?.trim() || "0";
        const addBtn = card.querySelector(".product-add");
        const productId = addBtn?.dataset?.id || "";
        const productDbId = addBtn?.dataset?.productDbId || ""; // ✅ NEW
        const datasetName = addBtn?.dataset?.name || productName;
        const datasetPrice = addBtn?.dataset?.price || productPriceText;

        els.kicker.textContent = productCat || "Product";
        els.name.textContent = productName;
        els.price.textContent = productPriceText;

        // "Open full page" (use card detail url always)
        const detailUrl = card.getAttribute("data-detail-url") || "#";
        els.open.href = detailUrl;

        const images = [primaryImg, hoverImg].filter(Boolean);
        renderThumbs(images.length ? images : [primaryImg || hoverImg], productName);

        els.add.onclick = () => addToCart(productId, productDbId, datasetName, datasetPrice, primaryImg || hoverImg, card);

        openModal();
      });
    })();
    </script>

</section>
</main>
{% endblock %} 